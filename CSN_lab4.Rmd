---
title: "R Notebook"
output: html_notebook
---

```{r}
library(dplyr)
library(summarytools)
library(caret)
library("ggpubr")
```

## Load data

```{r}
languages <- c("Arabic", "Basque", "Catalan", "Chinese", "Czech", "English", "Greek", "Hungarian", "Italian", "Turkish")

table_1 <- data.frame(language=languages,
                     N = numeric(length(languages)),
                     mu_n = numeric(length(languages)),
                     sd_n = numeric(length(languages)),
                     mu_k = numeric(length(languages)),
                     sd_k = numeric(length(languages)))

for (l in 1:length(languages)) {
  lang <- languages[l]
  path <- paste("./data/",paste(lang,"_dependency_tree_metrics.txt",sep = ""),sep = "")
  raw_data <- read.table(path,header = FALSE,sep = " ",fill = TRUE,quote="", comment.char="") 
  colnames(raw_data) = c("vertices","degree_2nd_moment", "mean_length")
  raw_data = raw_data[order(raw_data$vertices),]
  # check validity
  valid_data <- raw_data %>% mutate(check = case_when(        
                                          (degree_2nd_moment >= (4-6)/vertices & degree_2nd_moment <= vertices-1) ~ "valid",
                                          TRUE ~ "invalid")) %>% filter(check == "valid")
  
  invalids = nrow(raw_data)-nrow(valid_data)
  print(paste("Invalid values for",lang,":",invalids))
  
  table_1$N[l] <- nrow(valid_data)
  table_1$mu_n[l] <- mean(valid_data$vertices)
  table_1$sd_n[l] <- sd(valid_data$vertices)
  table_1$mu_k[l] <- mean(valid_data$degree_2nd_moment)
  table_1$sd_k[l] <- sd(valid_data$degree_2nd_moment)
}
```


```{r}
Catalan = read.table("./data/Basque_dependency_tree_metrics.txt", header = FALSE)
colnames(Catalan) = c("vertices","degree_2nd_moment", "mean_length")
Catalan = Catalan[order(Catalan$vertices),]
```


### attempt initial scaling

```{r}
plot(Catalan$vertices, Catalan$degree_2nd_moment,
     xlab = "vertices", ylab = "degree 2nd moment")
lines(mean_Catalan$vertices,mean_Catalan$degree_2nd_moment, col = "green")
lines(Catalan$vertices,
     (1 - 1/Catalan$vertices)*(5 - 6/Catalan$vertices), col = "red")
lines(Catalan$vertices,4-6/Catalan$vertices, col = "blue")
lines(Catalan$vertices,Catalan$vertices-1, col = "blue")
```

```{r}
plot(Catalan$vertices, Catalan$degree_2nd_moment,
     xlab = "vertices", ylab = "degree 2nd moment")
plot(mean_Catalan$vertices, mean_Catalan$degree_2nd_moment,
     xlab = "mean vertices", ylab = "mean degree 2nd moment")

```



###################################################

# Non-linear regression

## MODEL 1

```{r}
b_initial = 4
start1 <- Sys.time()
nonlinear_model = nls(degree_2nd_moment~(vertices/2)^b,data=Catalan,start = list(b = b_initial))
end1 <- Sys.time()
coef(nonlinear_model)[1]
end1-start1
```

### initial params with linear reg

```{r}
# log ⟨d⟩ = b log n + a′,
linear_model = lm(log(degree_2nd_moment)~log(vertices), Catalan)
a_linreg = exp(coef(linear_model)[1])
b_linreg = coef(linear_model)[2]

paste('a_linreg:',a_linreg,'b_linreg:',b_linreg, sep = ' ')

start1 <- Sys.time()
nonlinear_model = nls(degree_2nd_moment~(vertices/2)^b,data=Catalan,start = list(b = b_linreg))
end1 <- Sys.time()
coef(nonlinear_model)[1]
end1-start1
```

```{r}
plot(linear_model)
```

Heteroskedasticity and non normally distributed residuals!

Let's take the average k_2nd_moment for each sentence length, so we take care of possible outliers, and partly solve the heteroskedasticity issue. However, longer sentences still show high variability, so we will compute confidence intervals for the coefficients through Eickert-White procedure

## mean and outliers

```{r}
mean_Catalan = aggregate(Catalan, list(Catalan$vertices), mean)
sd <- sd(mean_Catalan$degree_2nd_moment)
mean <- mean(mean_Catalan$degree_2nd_moment)

par(mfrow=c(1,2))

plot(Catalan$vertices, Catalan$degree_2nd_moment,
       xlab = "vertices", ylab = "mean mean degree_2nd_moment")

plot(mean_Catalan$vertices, mean_Catalan$degree_2nd_moment,
       xlab = "vertices", ylab = "mean mean degree_2nd_moment")
abline(h=mean+3*sd)
text(mean_Catalan$vertices, mean_Catalan$degree_2nd_moment,labels=rownames(mean_Catalan),cex=0.9, font=2)

#mean_Catalan <- mean_Catalan %>% mutate(outlier = case_when(
#  degree_2nd_moment > mean+3*sd ~ "out",
#  TRUE ~ "in" )) %>% filter(outlier == "in") %>% select(-outlier)

```

 
 
### Not assuming homoskedasticity 

Source: https://www.r-bloggers.com/2015/06/heteroscedasticity-in-regression-it-matters/
Code: https://github.com/matloff/misc/blob/master/NlsHC.R

```{r}
library(minpack.lm)
library(sandwich)

nlsvcovhc <- function(nlslmout) {
  
 # uses output of nlsLM() of the minpack.lm package to get an asymptotic 
 # covariance matrix without assuming homoscedasticity
  
 b <- coef(nlslmout)
 m <- nlslmout$m
 resid <- m$resid()
 hmat <- m$gradient()
 fakex <- hmat
 fakey <- resid + hmat %*% b
 lmout <- lm(fakey ~ fakex - 1)
 vcovHC(lmout)
}
```


"vcov() inputs the result of a call to lm() or nls(), and outputs the estimated covariance matrix of your estimated parameter vector. Thus the standard errors of the estimated parameters are the square roots of the diagonal elements of the matrix returned by vcov()."

Fit the model with nlsLM: https://www.rdocumentation.org/packages/minpack.lm/versions/1.2-1/topics/nlsLM


```{r}
# check the vcov matrix with standard nls()
nonlinear_model_1 = nls(degree_2nd_moment~(vertices/2)^b,data=Catalan,start = list(b = b_linreg))
print(vcov(nonlinear_model_1))

# check the vcov matrix with standard nls()
nonlinear_model_1 = nlsLM(degree_2nd_moment~(vertices/2)^b,data=Catalan,start = list(b = b_linreg))
print(nlsvcovhc(nonlinear_model_1))
```


## MODEL 2 - power law

```{r}
#f(n) = an^b
a_initial = 4
b_initial = 4
start1 <- Sys.time()
nonlinear_model = nls(degree_2nd_moment~a*(vertices)^b, data=Catalan, start = list(a = a_linreg, b = b_linreg))
end1 <- Sys.time()
coef(nonlinear_model)[1]
coef(nonlinear_model)[2]
end1-start1
```


```{r}
# check the vcov matrix with standard nls()
print(diag(sqrt(vcov(nonlinear_model))))

# check the estimated standard deviations with nlsLM() and Eickert-White CI
nonlinear_model = nlsLM(degree_2nd_moment~a*(vertices)^b,data=Catalan,start = list(a = a_linreg, b = b_linreg))
print(diag(sqrt(nlsvcovhc(nonlinear_model))))
```

```{r}
# check the vcov matrix with standard nls()
print(diag(sqrt(vcov(nonlinear_model))))

# check the estimated standard deviations with nlsLM() and Eickert-White CI
nonlinear_model = nlsLM(degree_2nd_moment~a*(vertices)^b,data=Catalan,start = list(a = a_linreg, b = b_linreg))
print(diag(sqrt(nlsvcovhc(nonlinear_model))))
```



#############################################

# AGGREGATED DATA

```{r}
#grouped_Catalan <- Catalan %>% group_by(vertices) %>% dplyr::summarize(Mean_k2m = mean(degree_2nd_moment, na.rm=TRUE))
```


## Model 0 

```{r}
n <- length(grouped_Catalan$vertices)
RSS <- sum((grouped_Catalan$Mean_k2m - (1-1/grouped_Catalan$vertices)*(5-6/grouped_Catalan$vertices)))
p <- 0

# scores
s <- sqrt(RSS/(n - p))
AIC <- n*log(2*pi) + n*log(RSS/n) + n + 2*(p + 1)
paste("s:",s,"- AIC:", AIC)

# plot

plot(grouped_Catalan$vertices, grouped_Catalan$Mean_k2m,
    xlab = "vertices", ylab = "degree 2nd moment")
#lines(grouped_Catalan$vertices,grouped_Catalan$Mean_k2m, col = "green")
lines(grouped_Catalan$vertices,
    (1 - 1/grouped_Catalan$vertices)*(5 - 6/grouped_Catalan$vertices), col = "red")
lines(grouped_Catalan$vertices,4-6/grouped_Catalan$vertices, col = "blue")
lines(grouped_Catalan$vertices,grouped_Catalan$vertices-1, col = "blue")


```



## Model 1

```{r}
linear_model = lm(log(degree_2nd_moment)~log(vertices), mean_Catalan)
a_linreg = exp(coef(linear_model)[1])
b_linreg = coef(linear_model)[2]

# reg
nonlinear_model = nls(degree_2nd_moment~(vertices/2)^b, data= mean_Catalan, start = list(b = b_linreg))
b_opt = coef(nonlinear_model)["b"]

# scores
AIC <- AIC(nonlinear_model)
s <- sqrt(deviance(nonlinear_model)/df.residual(nonlinear_model))
paste("s:",s,"- AIC:", AIC)

# proper confidence intervals 
sd_b <- diag(sqrt(nlsvcovhc(nonlinear_model)))[1]
# CI/2 = z* σ/√n, where alfa=0.05 and Z(1-alfa/2) = 1.96 
N <- nrow(mean_Catalan)
half_CI <- 1.96*(sd_b/sqrt(N))

plot(grouped_Catalan$vertices, mean_Catalan$degree_2nd_moment,
    xlab = "vertices", ylab = "degree 2nd moment")
lines(mean_Catalan$vertices, (mean_Catalan$vertices/2)^b_opt , col = "red")
lines(mean_Catalan$vertices,4-6/mean_Catalan$vertices, col = "blue")
lines(mean_Catalan$vertices,mean_Catalan$vertices-1, col = "blue")
```




# Model 1+

```{r}
linear_model = lm(log(degree_2nd_moment)~log(vertices), mean_Catalan)
a_linreg = exp(coef(linear_model)[1])
b_linreg = coef(linear_model)[2]

d_initial <- 7
model_1plus = nls(Mean_k2m~(vertices/2)^b + d, data= grouped_Catalan, start = list(b = b_linreg, d = d_initial))
b_opt <- coef(model_1plus)["b"]
d_opt <- coef(model_1plus)["d"]

# scores
RSS <- deviance(model_1plus)
AIC <- AIC(model_1plus)
s <- sqrt(deviance(model_1plus)/df.residual(model_1plus))
paste("s:",s,"- AIC:", AIC)

plot(grouped_Catalan$vertices, grouped_Catalan$Mean_k2m,
    xlab = "vertices", ylab = "degree 2nd moment")
lines(grouped_Catalan$vertices, (grouped_Catalan$vertices/2)^b_opt + d_opt , col = "red")
lines(grouped_Catalan$vertices,4-6/grouped_Catalan$vertices, col = "blue")
lines(grouped_Catalan$vertices,grouped_Catalan$vertices-1, col = "blue")

```



# Model 2

Same regression as before

```{r}
linear_model = lm(log(degree_2nd_moment)~log(vertices), mean_Catalan)
a_linreg = exp(coef(linear_model)[1])
b_linreg = coef(linear_model)[2]

#f(n) = an^b
nonlinear_model = nls(Mean_k2m~a*(vertices)^b, data=grouped_Catalan, start = list(a = a_linreg, b = b_linreg))
a_opt <- coef(nonlinear_model)["a"]
b_opt <- coef(nonlinear_model)["b"]
paste("a_opt:",a_opt,"- b_opt:", b_opt)

# scores
RSS <- deviance(nonlinear_model)
AIC <- AIC(nonlinear_model)
s <- sqrt(deviance(nonlinear_model)/df.residual(nonlinear_model))
paste("s:",s,"- AIC:", AIC)

plot(grouped_Catalan$vertices, grouped_Catalan$Mean_k2m,
    xlab = "vertices", ylab = "degree 2nd moment")
lines(grouped_Catalan$vertices, a_opt*(grouped_Catalan$vertices)^b_opt , col = "red")
lines(grouped_Catalan$vertices,4-6/grouped_Catalan$vertices, col = "blue")
lines(grouped_Catalan$vertices,grouped_Catalan$vertices-1, col = "blue")
```


# Model 2+

```{r}
Czech = read.table("./data/Czech_dependency_tree_metrics.txt", header = FALSE)
colnames(Catalan) = c("vertices","degree_2nd_moment", "mean_length")
Catalan = Catalan[order(Catalan$vertices),]
```


```{r}
linear_model_2 = lm(log(degree_2nd_moment)~log(vertices), mean_Catalan)
a_initial = exp(coef(linear_model_2)[1])
b_initial = coef(linear_model_2)[2]


weigths <- ifelse(mean_Catalan$vertices>49,1,0.9)

d_initial <- 0
model_2plus = nls(degree_2nd_moment~a*(vertices)^b + d, data=mean_Catalan, 
                  start = list(a = a_initial, b = b_initial, d = d_initial),
                  control = list(maxiter=1000),
                  algorithm = 'port',
                  lower=c(0,0,-20),
                  upper=c(20,5,20),
                  weights = )

a_opt <- coef(model_2plus)["a"]
b_opt <- coef(model_2plus)["b"]
d_opt <- coef(model_2plus)["d"]
paste("a_opt:",a_opt,"- b_opt:", b_opt)
help(nls)

# scores
RSS <- deviance(nonlinear_model)
AIC <- AIC(nonlinear_model)
s <- sqrt(deviance(nonlinear_model)/df.residual(nonlinear_model))
paste("s:",s,"- AIC:", AIC)

setEPS()
postscript("catalan_2+.eps")
plot(mean_Catalan$vertices, mean_Catalan$degree_2nd_moment,
    xlab = "vertices", ylab = "degree 2nd moment")
lines(mean_Catalan$vertices, a_opt*(mean_Catalan$vertices)^b_opt + d_opt , col = "red", ylim = c(0,10))
#lines(grouped_Catalan$vertices, 20*(grouped_Catalan$vertices)^0.0398 - 17.84 , col = "red", ylim = c(0,10))
lines(mean_Catalan$vertices,4-6/mean_Catalan$vertices, col = "blue")
lines(mean_Catalan$vertices,mean_Catalan$vertices-1, col = "blue")
dev.off()
```

```{r}
#plot(nonlinear_model)
```





# Model 3 


```{r}
linear_model_3 = lm(log(Mean_k2m)~vertices, grouped_Catalan)
a_linreg_3 = exp(coef(linear_model_3)[1])
c_linreg_3 = coef(linear_model_3)[2]

model_3 = nls(Mean_k2m~a*exp(c*vertices), data=grouped_Catalan, start = list(a = a_linreg_3, c = c_linreg_3))
a_opt <- coef(model_3)["a"]
c_opt <- coef(model_3)["c"]

# scores
RSS <- deviance(model_3)
AIC <- AIC(model_3)
s <- sqrt(deviance(model_3)/df.residual(model_3))
paste("s:",s,"- AIC:", AIC)

plot(grouped_Catalan$vertices, grouped_Catalan$Mean_k2m,
    xlab = "vertices", ylab = "degree 2nd moment")
lines(grouped_Catalan$vertices, a_opt*exp(c_opt*grouped_Catalan$vertices) , col = "red")
lines(grouped_Catalan$vertices,4-6/grouped_Catalan$vertices, col = "blue")
lines(grouped_Catalan$vertices,grouped_Catalan$vertices-1, col = "blue")

```

```{r}
coefficients_df_screen[,2:11] <- sapply(coefficients_df_screen[,2:11], as.numeric)
plot(coefficients_df_screen)
```

```{r}
nonlinear_model_1 = nls(degree_2nd_moment~(vertices/2)^b,data=Catalan,start = list(b = b_linreg))
print(vcov(nonlinear_model_1))

# check the vcov matrix with standard nls()
nonlinear_model_1 = nlsLM(degree_2nd_moment~(vertices/2)^b,data=Catalan,start = list(b = b_linreg))
print(nlsvcovhc(nonlinear_model_1))

```


####################################

# PLOTS

```{r}

plot_bestmodel <- function(info) {
    languages <- c("Arabic", "Basque", "Catalan", "Chinese", "Czech", "English", "Greek", "Hungarian", "Italian", "Turkish")
    langs_2p <- c("Arabic", "Basque", "Catalan", "English", "Greek", "Hungarian", "Italian")
    langs_0 <- c("Chinese","Turkish")
    langs_1p <- c("Czech")
    
    for (l in 1:length(languages)) {
      lang <- languages[l]
      path <- paste("./data/",paste(lang,"_dependency_tree_metrics.txt",sep = ""),sep = "")
      raw_data <- read.table(path,header = FALSE,sep = " ",fill = TRUE,quote="", comment.char="") 
      colnames(raw_data) = c("vertices","degree_2nd_moment", "mean_length")
      raw_data = raw_data[order(raw_data$vertices),]
      # check validity
      valid_data <- raw_data %>% mutate(check = case_when(        
                                              (degree_2nd_moment >= (4-6)/vertices & degree_2nd_moment <= vertices-1) ~ "valid",
                                              TRUE ~ "invalid")) %>% filter(check == "valid") %>% select(-check)
      # aggregate
      mean_lang = aggregate(valid_data, list(valid_data$vertices), mean)
      
      # remove outliers (y value > mean+3*sd)
      sd <- sd(mean_lang$degree_2nd_moment)
      mean <- mean(mean_lang$degree_2nd_moment)
      
      mean_lang <- mean_lang %>% mutate(outlier = case_when(
        degree_2nd_moment > mean+3*sd ~ "out",
        TRUE ~ "in" )) %>% filter(outlier == "in") %>% select(-outlier)
      
      if (lang %in% langs_2p) {
        model <- "2_p"
        
        a_opt <- coefficients_df_screen$`2+: a`[coefficients_df_screen$Language == lang]
        b_opt <- coefficients_df_screen$`2+: b`[coefficients_df_screen$Language == lang]
        d_opt <- coefficients_df_screen$`2+: d`[coefficients_df_screen$Language == lang]
        
        setEPS()
        postscript(paste(lang,model,".eps",sep='_'))
        plot(mean_lang$vertices, mean_lang$degree_2nd_moment,
            xlab = "vertices", ylab = "degree 2nd moment")
        lines(mean_lang$vertices, a_opt*(mean_lang$vertices)^b_opt + d_opt , col = "red", ylim = c(0,10))
        lines(mean_lang$vertices,4-6/mean_lang$vertices, col = "blue")
        lines(mean_lang$vertices,mean_lang$vertices-1, col = "blue")
        dev.off()
      }
      
        if (lang %in% langs_0) {
        model <- "0"
        
        setEPS()
        postscript(paste(lang,model,".eps",sep='_'))
        plot(mean_lang$vertices, mean_lang$degree_2nd_moment, xlab = "vertices", ylab = "degree 2nd moment")
        lines(mean_lang$vertices,(1 - 1/mean_lang$vertices)*(5 - 6/mean_lang$vertices), col = "red")
        lines(mean_lang$vertices,4-6/mean_lang$vertices, col = "blue")
        lines(mean_lang$vertices,mean_lang$vertices-1, col = "blue")
        dev.off()
      }
        
        else if (lang %in% langs_1p) {
        model <- "1p"
        
        b_opt <- coefficients_df_screen$`1+: b`[coefficients_df_screen$Language == lang]
        d_opt <- coefficients_df_screen$`1+: d`[coefficients_df_screen$Language == lang]
        
        setEPS()
        postscript(paste(lang,model,info,".eps",sep='_'))
        plot(mean_lang$vertices, mean_lang$degree_2nd_moment, xlab = "vertices", ylab = "degree 2nd moment")
        lines(mean_lang$vertices,(mean_lang$vertices/2)^b_opt + d_opt, col = "red")
        lines(mean_lang$vertices,4-6/mean_lang$vertices, col = "blue")
        lines(mean_lang$vertices,mean_lang$vertices-1, col = "blue")
        dev.off()
      }
    }
}

plot_bestmodel("")
```












